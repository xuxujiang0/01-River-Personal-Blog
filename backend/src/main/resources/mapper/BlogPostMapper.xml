<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.river.blog.mapper.BlogPostMapper">
    
    <resultMap id="BaseResultMap" type="com.river.blog.entity.BlogPost">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="title" property="title"/>
        <result column="excerpt" property="excerpt"/>
        <result column="content" property="content"/>
        <result column="cover" property="cover"/>
        <result column="views" property="views"/>
        <result column="comments" property="comments"/>
        <result column="status" property="status"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>
    
    <sql id="Base_Column_List">
        id, user_id, title, excerpt, content, cover, views, comments, status, created_at, updated_at
    </sql>
    
    <!-- 根据ID查询 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM blog_posts
        WHERE id = #{id}
    </select>
    
    <!-- 查询列表 -->
    <select id="selectList" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM blog_posts
        <where>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
        </where>
        ORDER BY created_at DESC
        <if test="offset != null and limit != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>
    
    <!-- 查询总数 -->
    <select id="countByStatus" resultType="int">
        SELECT COUNT(*)
        FROM blog_posts
        <where>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
        </where>
    </select>
    
    <!-- 插入博客 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO blog_posts (user_id, title, excerpt, content, cover, status)
        VALUES (#{userId}, #{title}, #{excerpt}, #{content}, #{cover}, #{status})
    </insert>
    
    <!-- 更新博客 -->
    <update id="update">
        UPDATE blog_posts
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="excerpt != null">excerpt = #{excerpt},</if>
            <if test="content != null">content = #{content},</if>
            <if test="cover != null">cover = #{cover},</if>
            <if test="status != null">status = #{status},</if>
        </set>
        WHERE id = #{id}
    </update>
    
    <!-- 删除博客 -->
    <delete id="deleteById">
        DELETE FROM blog_posts WHERE id = #{id}
    </delete>
    
    <!-- 增加浏览量 -->
    <update id="incrementViews">
        UPDATE blog_posts SET views = views + 1 WHERE id = #{id}
    </update>
    
    <!-- 更新状态 -->
    <update id="updateStatus">
        UPDATE blog_posts SET status = #{status} WHERE id = #{id}
    </update>
    
    <!-- 更新评论数 -->
    <update id="updateCommentCount">
        UPDATE blog_posts SET comments = #{comments} WHERE id = #{id}
    </update>
    
    <!-- 查询博客的内容图片 -->
    <select id="selectContentImages" resultType="string">
        SELECT image_url
        FROM blog_content_images
        WHERE post_id = #{postId}
        ORDER BY sort_order
    </select>
    
    <!-- 插入内容图片 -->
    <insert id="insertContentImage">
        INSERT INTO blog_content_images (post_id, image_url, sort_order)
        VALUES (#{postId}, #{imageUrl}, #{sortOrder})
    </insert>
    
    <!-- 删除博客的所有内容图片 -->
    <delete id="deleteContentImages">
        DELETE FROM blog_content_images WHERE post_id = #{postId}
    </delete>
    
</mapper>
